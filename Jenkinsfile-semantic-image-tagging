// Build Docker Image with Automatic Semantic Version Tagging
// Pre-requisite: Jenkins needs repo write access (e.g GitHub PAT)

pipeline {
    agent {
        label 'BUILD-SERVER1-192.168.20.211'
    }

    environment {
        CONTAINER_NAME        = "myapp"
        DOCKER_FILENAME       = "Dockerfile"
        DOCKER_HUB_USERNAME   = "jamaldevsecops"
        DOCKER_CREDENTIALS_ID = "PersonalDockerHubAccessToken"
        RECIPIENT_EMAILS      = "jamal.devsecops@gmail.com"
    }

    stages {
        stage('üì• Checkout') {
            steps {
                checkout scm
                sh 'git fetch --tags'
            }
        }

        stage('üî¢ Determine Next Semantic Version') {
            steps {
                script {
                    sh 'git fetch --tags'

                    def latestTag = sh(returnStdout: true, script: "git describe --tags --abbrev=0 || echo v0.0.0").trim()
                    echo "Latest Git tag: ${latestTag}"

                    def versionNumbers = latestTag.replaceFirst(/^v/, '').split('\\.')
                    def major = versionNumbers[0].toInteger()
                    def minor = versionNumbers[1].toInteger()
                    def patch = versionNumbers[2].toInteger()

                    // bump until new tag available
                    while(sh(returnStatus: true, script: "git rev-parse v${major}.${minor}.${patch}") == 0) {
                        patch += 1
                    }

                    env.IMAGE_TAG = "v${major}.${minor}.${patch}"
                    echo "Next available version: ${env.IMAGE_TAG}"

                    withCredentials([string(credentialsId: 'GitHub-PAT', variable: 'GIT_TOKEN')]) {
                        sh """
                            git config user.email "ci-bot@company.com"
                            git config user.name "CI Bot"
                            git tag ${env.IMAGE_TAG}
                            git push https://x-access-token:$GIT_TOKEN@github.com/jamaldevsecops/myapp.git ${env.IMAGE_TAG}
                        """
                    }
                }
            }
        }

        stage('üîß Build & Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("https://index.docker.io/v1/", env.DOCKER_CREDENTIALS_ID) {
                        def imageName = "${env.DOCKER_HUB_USERNAME}/${env.CONTAINER_NAME}:${env.IMAGE_TAG}"
                        echo "üîß Building Docker image: ${imageName}"
                        def app = docker.build(imageName, "-f ${env.DOCKER_FILENAME} .")

                        echo "üì§ Pushing Docker image..."
                        app.push()
                        app.push("latest")
                        env.DOCKER_IMAGE = imageName

                        env.DOCKER_DIGEST = sh(returnStdout: true, script: "docker inspect --format='{{index .RepoDigests 0}}' ${imageName}").trim()
                        echo "‚úÖ Docker image pushed: ${env.DOCKER_IMAGE} (${env.DOCKER_DIGEST})"
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                emailext(
                    subject: "‚úÖ [SUCCESS] Build Report: ${env.CONTAINER_NAME} üöÄ",
                    mimeType: 'text/html',
                    to: "${env.RECIPIENT_EMAILS}",
                    attachLog: true,
                    body: """
                    <html>
                    <body>
                        <h2 style="color:green;">Build Status: SUCCESS ‚úÖ</h2>
                        <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
                            <tr><th align="left">Docker Image</th><td>${env.DOCKER_IMAGE}</td></tr>
                            <tr><th align="left">Digest</th><td>${env.DOCKER_DIGEST}</td></tr>
                            <tr><th align="left">Git Tag</th><td>${env.IMAGE_TAG}</td></tr>
                        </table>
                        <p>The Docker image has been successfully built, tagged, and pushed to DockerHub.</p>
                    </body>
                    </html>
                    """
                )
            }
        }

        failure {
            script {
                emailext(
                    subject: "‚ùå [FAILURE] Build Report: ${env.CONTAINER_NAME} üí•",
                    mimeType: 'text/html',
                    to: "${env.RECIPIENT_EMAILS}",
                    attachLog: true,
                    body: """
                    <html>
                    <body>
                        <h2 style="color:red;">Build Status: FAILED ‚ùå</h2>
                        <table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse;">
                            <tr><th align="left">Docker Image Attempted</th><td>${env.CONTAINER_NAME}:${env.IMAGE_TAG}</td></tr>
                        </table>
                        <p>Please review the Jenkins logs for details.</p>
                    </body>
                    </html>
                    """
                )
            }
        }
    }
}
