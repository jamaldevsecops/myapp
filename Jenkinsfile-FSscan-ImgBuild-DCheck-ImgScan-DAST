pipeline {
    agent { label 'BUILD-SERVER' }

    parameters {
        string(name: 'OVERRIDE_TAG', defaultValue: '', description: 'Optional: override auto-generated image tag')
    }

    environment {
        CONTAINER_NAME        = "myapp"
        DOCKER_FILENAME       = "Dockerfile"
        DOCKER_HUB_USERNAME   = "jamaldevsecops"
        DOCKER_CREDENTIALS_ID = "PersonalDockerHubAccessToken"
        RECIPIENT_EMAILS      = "jamalhossain.devsecops@gmail.com"
        DEP_CHECK_NAME        = "OWASP-DC"   // Jenkins Global Tool Config name
        SLEEP_TIME            = "45"         // Time (in seconds) to keep app running for DAST scan
    }

    stages {

        stage('üì• Checkout') {
            steps {
                echo "üì• Checking out source code..."
                checkout scm
                script {
                    sh 'git fetch --tags'
                    def gitTag = sh(returnStdout: true, script: "git describe --tags --abbrev=0 || echo ''").trim()
                    def commitHash = sh(returnStdout: true, script: "git rev-parse --short HEAD").trim()

                    if (params.OVERRIDE_TAG?.trim()) {
                        env.IMAGE_TAG = params.OVERRIDE_TAG
                        echo "üîñ Using override tag: ${env.IMAGE_TAG}"
                    } else if (gitTag) {
                        env.IMAGE_TAG = gitTag.startsWith('v') ? gitTag.substring(1) : gitTag
                        echo "üîñ Using Git tag as image tag: ${env.IMAGE_TAG}"
                    } else {
                        env.IMAGE_TAG = commitHash
                        echo "üîñ No Git tag found. Using commit hash as image tag: ${env.IMAGE_TAG}"
                    }

                    env.GIT_COMMIT_HASH = commitHash
                    env.GIT_BRANCH = sh(returnStdout: true, script: "git rev-parse --abbrev-ref HEAD").trim()
                }
            }
        }

        stage('Trivy Filesystem Scan') {
            steps {
                script {
                    echo "üîç Running Trivy filesystem scan (source dependencies)..."
                    sh '''
                      mkdir -p reports
                      curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o html.tpl
                      trivy fs --exit-code 0 --severity LOW,MEDIUM,HIGH,CRITICAL --format json -o reports/trivy-fs-report.json .
                      trivy fs --format template --template @html.tpl -o reports/trivy-fs-report.html .
                    '''
                }
            }
            post {
                always {
                    echo "üì¶ Archiving Trivy FS reports..."
                    archiveArtifacts artifacts: 'reports/trivy-fs-report.*', fingerprint: true
                }
            }
        }

        stage('üîß Build & Push Docker Image') {
            steps {
                script {
                    def imageName = "${env.DOCKER_HUB_USERNAME}/${env.CONTAINER_NAME}:${env.IMAGE_TAG}"
                    docker.withRegistry("https://index.docker.io/v1/", env.DOCKER_CREDENTIALS_ID) {
                        echo "üîß Building Docker image: ${imageName}"
                        def app = docker.build(imageName, "-f ${env.DOCKER_FILENAME} .")
                        echo "üì§ Pushing Docker image..."
                        app.push()
                        app.push("latest")
                    }
                    env.DOCKER_IMAGE = imageName
                    env.DOCKER_DIGEST = sh(returnStdout: true, script: "docker inspect --format='{{index .RepoDigests 0}}' ${imageName}").trim()
                    echo "‚úÖ Docker image pushed: ${env.DOCKER_IMAGE} (${env.DOCKER_DIGEST})"
                }
            }
        }

        stage('üß© OWASP Dependency-Check') {
            steps {
                script {
                    echo "üîç Running OWASP Dependency-Check analysis..."
                    dependencyCheck additionalArguments: '--format XML --format HTML --enableExperimental',
                        odcInstallation: "${env.DEP_CHECK_NAME}"
                }
            }
            post {
                always {
                    echo "üì¶ Archiving Dependency-Check reports..."
                    archiveArtifacts artifacts: '*.xml,*.html', fingerprint: true
                    dependencyCheckPublisher pattern: 'dependency-check-report.xml'
                }
            }
        }

        stage('üõ°Ô∏è Trivy Image Scan') {
            steps {
                script {
                    echo "üîç Running Trivy image scan..."
                    sh """
                        mkdir -p reports
                        curl -sSL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o html.tpl
                        trivy image --exit-code 0 --severity LOW,MEDIUM,HIGH,CRITICAL --format json -o reports/trivy-image-report.json ${env.DOCKER_IMAGE}
                        trivy image --format template --template @html.tpl -o reports/trivy-image-report.html ${env.DOCKER_IMAGE}
                    """
                }
            }
            post {
                always {
                    echo "üì¶ Archiving Trivy Image reports..."
                    archiveArtifacts artifacts: 'reports/trivy-image-report.*', fingerprint: true
                }
            }
        }

        stage('üåê OWASP ZAP (DAST Scan)') {
            environment {
                CONTAINER_PORT  = "80"                   // Internal container port
                MAX_STARTUP_WAIT = 60                     // Max seconds to wait for container readiness
                ZAP_IMAGE       = "zaproxy/zap-stable:latest"
                ZAP_REPORT_BASE = "reports/zap"
                CONTAINER_INSTANCE = ""                   // Declare globally so post can access
                ZAP_REPORT_DIR     = ""
            }
            steps {
                script {
                    echo "üåê Starting OWASP ZAP DAST Scan..."
        
                    // Unique suffix for this build
                    def runSuffix = "${BUILD_ID}-${UUID.randomUUID().toString()[0..6]}"
                    
                    // Determine host port
                    def HOST_PORT = sh(
                        returnStdout: true,
                        script: '''
                            for i in $(seq 3000 3999); do
                                if ! sudo lsof -iTCP -sTCP:LISTEN -P -n | grep -q ":$i"; then
                                    echo $i
                                    break
                                fi
                            done
                        '''
                    ).trim()
        
                    if (!HOST_PORT) {
                        error("‚ùå No free host port found between 3000‚Äì3999!")
                    }
        
                    // Assign unique container and report names
                    env.CONTAINER_INSTANCE = "${env.CONTAINER_NAME}-${HOST_PORT}-${runSuffix}"
                    env.ZAP_REPORT_DIR = "${env.ZAP_REPORT_BASE}-${runSuffix}"
                    sh "mkdir -p ${env.ZAP_REPORT_DIR}"
        
                    echo "üöÄ Test container: ${env.CONTAINER_INSTANCE} ‚Üí localhost:${HOST_PORT}:${CONTAINER_PORT}"
        
                    // Pull images
                    docker.withRegistry("https://index.docker.io/v1/", env.DOCKER_CREDENTIALS_ID) {
                        sh "docker pull ${env.DOCKER_IMAGE}"
                        sh "docker pull ${ZAP_IMAGE}"
                    }
        
                    // Launch container with retries
                    def MAX_RETRIES = 3
                    def success = false
                    def attempt = 1
        
                    while (attempt <= MAX_RETRIES && !success) {
                        echo "üîÅ Attempt #${attempt} to launch test container..."
                        def runResult = sh(
                            returnStatus: true,
                            script: """
                                docker run -d --rm --log-driver json-file --name ${env.CONTAINER_INSTANCE} \
                                    -p ${HOST_PORT}:${CONTAINER_PORT} ${env.DOCKER_IMAGE} || \
                                    (docker logs ${env.CONTAINER_INSTANCE} > ${env.ZAP_REPORT_DIR}/${env.CONTAINER_INSTANCE}-error.log)
                            """
                        )
        
                        if (runResult == 0) {
                            echo "‚úÖ Container started successfully on port ${HOST_PORT}"
                            success = true
                        } else {
                            echo "‚ö†Ô∏è Failed to start container on attempt #${attempt}. Retrying..."
                            attempt++
                            sleep 5
                        }
                    }
        
                    if (!success) {
                        error("‚ùå All attempts to start the container failed. Aborting ZAP scan.")
                    }
        
                    // Wait for container readiness
                    echo "‚è≥ Waiting for container readiness on port ${HOST_PORT}..."
                    def ready = false
                    def waited = 0
                    while (!ready && waited < MAX_STARTUP_WAIT.toInteger()) {
                        def result = sh(returnStatus: true, script: "curl -s http://localhost:${HOST_PORT} > /dev/null")
                        if (result == 0) { ready = true } else { sleep 2; waited += 2 }
                    }
                    if (!ready) echo "‚ö†Ô∏è Container did not become ready in ${MAX_STARTUP_WAIT}s. Proceeding anyway..."
        
                    // Run ZAP scan
                    sh """
                        docker run --rm --log-driver json-file \
                            -v \$(pwd)/${env.ZAP_REPORT_DIR}:/zap/wrk:rw --network host \
                            ${ZAP_IMAGE} zap-baseline.py -t http://localhost:${HOST_PORT} \
                            -r zap-report.html || true
                    """
        
                    // Stop app container
                    sh "docker stop ${env.CONTAINER_INSTANCE} || true"
                }
            }
            post {
                always {
                    script {
                        echo "üì¶ Archiving OWASP ZAP report..."
                        archiveArtifacts artifacts: "${env.ZAP_REPORT_DIR}/zap-report.html, ${env.ZAP_REPORT_DIR}/${env.CONTAINER_INSTANCE}-error.log", fingerprint: true
                    }
                }
            }
        }

    }

    post {
        always {
            script {
                sh 'ls -l reports/trivy-*.html reports/trivy-*.json dependency-check-report*.html dependency-check-report*.xml reports/zap/zap-report.html || true'

                emailext(
                    subject: "üõ°Ô∏è [Security Report] ${env.CONTAINER_NAME}:${env.IMAGE_TAG}",
                    body: """
                        <html>
                        <body style="font-family: Arial, sans-serif; color: #333;">
                            <h2 style="color: #2E86C1;">Security Report Summary</h2>
                            <table border="1" cellpadding="6" cellspacing="0" style="border-collapse: collapse; font-size: 14px;">
                                <tr><td><strong>Docker Image</strong></td><td>${env.DOCKER_IMAGE}</td></tr>
                                <tr><td><strong>Digest</strong></td><td>${env.DOCKER_DIGEST}</td></tr>
                                <tr><td><strong>Git Branch</strong></td><td>${env.GIT_BRANCH}</td></tr>
                                <tr><td><strong>Git Commit</strong></td><td>${env.GIT_COMMIT_HASH}</td></tr>
                            </table>
                            <p style="margin-top: 15px;">
                                <strong>Attached Reports:</strong><br>
                                ‚Ä¢ Trivy Filesystem Scan (HTML, JSON)<br>
                                ‚Ä¢ OWASP Dependency-Check (HTML, XML)<br>
                                ‚Ä¢ Trivy Image Scan (HTML, JSON)<br>
                                ‚Ä¢ OWASP ZAP DAST Scan (HTML)
                            </p>
                        </body>
                        </html>
                    """,
                    mimeType: 'text/html',
                    to: "${env.RECIPIENT_EMAILS}",
                    attachLog: true,
                    attachmentsPattern: 'reports/trivy-*.html,reports/trivy-*.json,dependency-check-report*.html,dependency-check-report*.xml,reports/zap/zap-report.html'
                )
            }
        }
    }
}
